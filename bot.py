import anthropic
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes

# –∫–æ—Ä–æ—á –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–∏ —Ç–æ–∫–µ–Ω—ã –∏ –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç
TELEGRAM_TOKEN = "8401075719:AAEjXWcERcS9IEwRN9HKJQV8ivG7lwuEqUE"
ANTHROPIC_API_KEY = "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"

# —ç—Ç–æ —Ç–∏–ø–∞ "–º–æ–∑–≥" –Ω–∞—à–µ–≥–æ —Å–æ–∫—Ä–∞—Ç–∞ - –≥–æ–≤–æ—Ä–∏–º –∏–∏ –∫–µ–º –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å
SYSTEM_PROMPT = """–¢—ã ‚Äî –°–æ–∫—Ä–∞—Ç, –¥—Ä–µ–≤–Ω–µ–≥—Ä–µ—á–µ—Å–∫–∏–π —Ñ–∏–ª–æ—Å–æ—Ñ, –∫–æ—Ç–æ—Ä—ã–π –∏–∑—É—á–∏–ª –≤—Å—ë –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –†–§.

–¢–≤–æ–π —Å—Ç–∏–ª—å:
- –ì–æ–≤–æ—Ä–∏—à—å –º—É–¥—Ä–æ –Ω–æ –ø–æ –¥–µ–ª—É, –∏–Ω–æ–≥–¥–∞ –∑–∞–¥–∞—ë—à—å –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- –¶–∏—Ç–∏—Ä—É–µ—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ (–£–ö –†–§, –ì–ö –†–§, –¢–ö –†–§, –ö–æ–ê–ü, –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –∏ —Ç.–¥.)
- –ò–Ω–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏—à—å —Ç–∏–ø–∞ "–Ø –∑–Ω–∞—é –ª–∏—à—å —Ç–æ, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞—é... –Ω–æ —Å—Ç–∞—Ç—å—è 151 –ì–ö –†–§ –≥–æ–≤–æ—Ä–∏—Ç —Å–ª–µ–¥—É—é—â–µ–µ"
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—à—å —á—Ç–æ —Ç—ã –Ω–µ –∑–∞–º–µ–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–º—É —é—Ä–∏—Å—Ç—É
- –û—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º"""

# —Ç—É—Ç —Ö—Ä–∞–Ω–∏–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∫–∞–∂–¥–æ–≥–æ —é–∑–µ—Ä–∞
# –∫–ª—é—á = id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–Ω–∞—á–µ–Ω–∏–µ = —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
–∏—Å—Ç–æ—Ä–∏–∏ = {}

# –∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –∏–∏
–∫–ª–∏–µ–Ω—Ç = anthropic.Anthropic(api_key=ANTHROPIC_API_KEY)


async def —Å—Ç–∞—Ä—Ç(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç /start
    await update.message.reply_text(
        "üèõÔ∏è –ü—Ä–∏–≤–µ—Ç! –Ø –°–æ–∫—Ä–∞—Ç, –Ω–æ —à–∞—Ä—é –≤ –∑–∞–∫–æ–Ω–∞—Ö –†–§\n\n"
        "–°–ø—Ä–∞—à–∏–≤–∞–π –ø—Ä–æ —á—Ç–æ —É–≥–æ–¥–Ω–æ:\n"
        "‚Ä¢ –£–≤–æ–ª–∏–ª–∏ ‚Äî –∑–∞–∫–æ–Ω–Ω–æ –∏–ª–∏ –Ω–µ—Ç?\n"
        "‚Ä¢ –°–æ—Å–µ–¥ –∑–∞—Ç–æ–ø–∏–ª ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å?\n"
        "‚Ä¢ –ö—É–ø–∏–ª –±—Ä–∞–∫ –≤ –º–∞–≥–∞–∑–∏–Ω–µ ‚Äî –∫–∞–∫ –≤–µ—Ä–Ω—É—Ç—å?\n"
        "‚Ä¢ –®—Ç—Ä–∞—Ñ –≤—ã–ø–∏—Å–∞–ª–∏ ‚Äî –º–æ–∂–Ω–æ –æ—Å–ø–æ—Ä–∏—Ç—å?\n\n"
        "–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å! ‚öñÔ∏è\n\n"
        "P.S. /clear ‚Äî –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä –∑–∞–Ω–æ–≤–æ"
    )


async def —Å–±—Ä–æ—Å(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # —á–∏—Å—Ç–∏–º –∏—Å—Ç–æ—Ä–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞
    user_id = update.effective_user.id
    –∏—Å—Ç–æ—Ä–∏–∏[user_id] = []
    await update.message.reply_text("üóëÔ∏è –í—Å—ë, –Ω–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞!")


async def –æ—Ç–≤–µ—Ç–∏—Ç—å(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    –≤–æ–ø—Ä–æ—Å = update.message.text

    # –µ—Å–ª–∏ —é–∑–µ—Ä –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø–∏—à–µ—Ç - —Å–æ–∑–¥–∞—ë–º –µ–º—É –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é
    if user_id not in –∏—Å—Ç–æ—Ä–∏–∏:
        –∏—Å—Ç–æ—Ä–∏–∏[user_id] = []

    # –¥–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ –∏—Å—Ç–æ—Ä–∏—é
    –∏—Å—Ç–æ—Ä–∏–∏[user_id].append({
        "role": "user",
        "content": –≤–æ–ø—Ä–æ—Å
    })

    # –Ω–µ –¥–∞—ë–º –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑—Ä–∞—Å—Ç–∏—Å—å –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏, –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
    # –∏–Ω–∞—á–µ –±—É–¥–µ–º –ø–ª–∞—Ç–∏—Ç—å –∑–∞ —Ç–æ–∫–µ–Ω—ã –∫–∞–∫ –¥—É—Ä–∞–∫–∏
    if len(–∏—Å—Ç–æ—Ä–∏–∏[user_id]) > 10:
        –∏—Å—Ç–æ—Ä–∏–∏[user_id] = –∏—Å—Ç–æ—Ä–∏–∏[user_id][-10:]

    # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±–æ—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç" –ø–æ–∫–∞ –¥—É–º–∞–µ—Ç
    await context.bot.send_chat_action(
        chat_id=update.effective_chat.id,
        action="typing"
    )

    try:
        # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –∏–∏
        –æ—Ç–≤–µ—Ç = –∫–ª–∏–µ–Ω—Ç.messages.create(
            model="claude-opus-4-5",
            max_tokens=1024,
            system=SYSTEM_PROMPT,
            messages=–∏—Å—Ç–æ—Ä–∏–∏[user_id]
        )

        —Ç–µ–∫—Å—Ç_–æ—Ç–≤–µ—Ç–∞ = –æ—Ç–≤–µ—Ç.content[0].text

        # –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª —Å–æ–∫—Ä–∞—Ç
        –∏—Å—Ç–æ—Ä–∏–∏[user_id].append({
            "role": "assistant",
            "content": —Ç–µ–∫—Å—Ç_–æ—Ç–≤–µ—Ç–∞
        })

        await update.message.reply_text(—Ç–µ–∫—Å—Ç_–æ—Ç–≤–µ—Ç–∞)

    except Exception as –æ—à–∏–±–∫–∞:
        # —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≥–æ–≤–æ—Ä–∏–º —é–∑–µ—Ä—É
        print(f"–û—à–∏–±–∫–∞: {–æ—à–∏–±–∫–∞}")  # —ç—Ç–æ –≤ –ª–æ–≥–∏ –¥–ª—è –Ω–∞—Å
        await update.message.reply_text(
            "‚ö†Ô∏è –ß—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑\n"
            f"–û—à–∏–±–∫–∞: {–æ—à–∏–±–∫–∞}"
        )


def main():
    # —Å–æ–±–∏—Ä–∞–µ–º –±–æ—Ç–∞
    –±–æ—Ç = ApplicationBuilder().token(TELEGRAM_TOKEN).build()

    # –≤–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    –±–æ—Ç.add_handler(CommandHandler("start", —Å—Ç–∞—Ä—Ç))
    –±–æ—Ç.add_handler(CommandHandler("clear", —Å–±—Ä–æ—Å))

    # —ç—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–æ–≤–∏—Ç –≤—Å–µ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ –∫–æ–º–∞–Ω–¥—ã)
    –±–æ—Ç.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, –æ—Ç–≤–µ—Ç–∏—Ç—å))

    print("‚úÖ –°–æ–∫—Ä–∞—Ç –∑–∞–ø—É—â–µ–Ω, –∂–¥—ë–º –≤–æ–ø—Ä–æ—Å–æ–≤!")
    –±–æ—Ç.run_polling()  # –∑–∞–ø—É—Å–∫–∞–µ–º –∏ —Å–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è


if __name__ == "__main__":
    main()
